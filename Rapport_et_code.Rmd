---
title: "Kidney"
author: "Otmane EL ALOI"
date: "11/03/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(mltools)
library(data.table)
library(survival)
```

# Présentation du projet:

### Présentation des données:

```{r data }
#la base de donnée existe déja sur le package survival 
#One hot encoding categorical variables 
data<-kidney
data<- one_hot(as.data.table(kidney),cols="disease")
#Adding a column indicating if it's the first or second occurence of the disease
data$is_first<-rep(c(1,0),38)
#Making the data looks like given in the project 
data1<-data%>%
  filter(is_first==1)%>%
  select(-c("id","is_first","frail"))
data2<-data%>%
  filter(is_first==0)%>%
  select(c('time','status','age'))%>%
  rename("time_2"="time","age_2"="age","status_2"="status")
data <-cbind(data1,data2)
data$sex<-data$sex-1
#Readable order 
data<-data[,c(1,9,2,10,3,11,4,5,6,7,8)]
View(data)
```

Dans ce projet on analyse le premier et second temps d'apparition de la maladie du rein chez 38 patient (c'est pour cela qu'on a un tableau de 76 ligne).

Notre base de donnée contient les colones suivants :

```{r}
print(names(data))
```

-   id: unique, correspond à chaque patient.

-   time : le temp du premier ou second récurrence de l'infection.

-   status: 0 ou 1 et indique si le temps de récurrence et censuré 1 reprèsente censuration à droite.

-   age : l'âge du patient.

-   sex: le sexe du patient.

-   disease: la maladie du patient (GN,AN,PKD, OTHER)

-   frail : la fragilité comme estimé dans le papier original.

### choix du modèle :

L'analyse de temps de récurrence de l'infection entre dans ce qu'on appelle l'analyse de survie, parmi les modèles les plus utilisés pour mener de telle étude et la régression de Cox.

Appliquée dans notre à une étude longitudinale (la récidive de l'infection des maladies de reins) représenté par des données censurées.

On propose dans ce projet de mener une étude bayésienne pour estimer les paramètres de la fonction de survie modélisé ici par un une distribution de weibull.

(\#Faut écrire les équations du problème: je vais les écrire après )

on considère exp(...) comme modélisation pour \$\$\mu\$\$ vu qu'elle reprèsente le pramètre shape de la loi de weibull qui est censé être postive.

### Code:

```{r}
MHWeibull_REffect <- function(data, iter = 5 * 10^4,
                      prop.sd = c(1,1,0.5,0.5,0.5,0.5,0.1,0.3)){
  ## Data is n x 9 matrix with time, age, status,sex,desease, censoring indicator
  time1 <-data[,1]
  time2<-data[,2]
  cens1 <- data[,3]
  cens2 <-data[,4]
  age1<-data[,5]
  age2<-data[,6]
  sex<-data[,7]
  d1<-data[,8]
  d2<-data[,9]
  d3<-data[,10]
  
  ## Define a "suitable" initial state for the chain
  init <- c(0,0,0,0,0,0,1,1)
  acc.rates <- 0
  chain <- matrix(NA, iter + 1, 8)
  #colnames(chain)<- c("alpha","beta_age","beta_sex","beta_1","beta_2","beta_3","tau","r")
  chain[1,] <- init
  
  #Modifying alpha, beta_age,beta_sex,beta_1,beta_2,beta_3
  for (i in 1:iter){
    current <- chain[i,]
    for (j in 1:6){
      prop<-current
      #Proposition
      prop[j]<-rnorm(1,current[j],prop.sd[j])
      b<-rnorm(38,0,current[7])
      #the top 
      scale1=exp(prop[1]+prop[2]*age1+prop[3]*sex+prop[4]*d1+prop[5]*d3+prop[6]*d3+b)
      print(scale1)
      scale2=exp(prop[1]+prop[2]*age2+prop[3]*sex+prop[4]*d1+prop[5]*d2+prop[6]*d3+b)   
      print(scale2)
      shape=rep(prop[8],38)
      print(shape)
      top <- log(dnorm(prop[j],0,100))+sum(dweibull(time1,shape,scale1))+sum(dweibulll(time2,shape,scale2))+sum(1-pweibull(time1,shape,scale1))+sum(1-pweibull(time2,shape,scale2))
      
      #The bottom
      scale1=exp(current[1]+current[2]*age1+current[3]*sex+current[4]*d1+current[5]*d3+current[6]*d3+b)
      scale2=exp(current[1]+current[2]*age2+current[3]*sex+current[4]*d1+current[5]*d2+current[6]*d3+b)
      shape=rep(current[8],38)
      bottom <- log(dnorm(prop[j],0,100))+sum(dweibull(time1,shape,scale1))+sum(dweibulll(time2,shape,scale2))+sum(1-pweibull(time1,shape,scale1))+sum(1-pweibull(time2,shape,scale2))

      alpha <- exp(top-bottom)
    
      if (runif(1) < alpha){
      current <- prop
      acc.rates <- acc.rates + 1
      }
    
    }
  }
  
  #Modfifying tau 
  prop<-current
  #Proposition
  prop[7]<-rnorm(1,current[7],prop.sd[7])
  b<-rnorm(38,0,current[8]) #(Je sais s'il faut regéner ça :())
  #the top 
  scale1=exp(prop[1]+prop[2]*age1+prop[3]*sex+prop[4]*d1+prop[5]*d3+prop[6]*d3+b)
  scale2=exp(prop[1]+prop[2]*age2+prop[3]*sex+prop[4]*d1+prop[5]*d3+prop[6]*d3+b)
  shape=rep(prop[8],38)
  top <- log(dgamma(prop[7],0.0001,10^(4)))+sum(dweibull(time1,shape,scale1))+sum(dweibulll(time2,shape,scale2))+sum(1-pweibull(time1,shape,scale1))+sum(1-pweibull(time2,shape,scale2))
        
  #The bottom
  scale1=exp(current[1]+current[2]*age1+current[3]*sex+current[4]*d1+current[5]*d3+current[6]*d3+b)
  scale1=exp(current[1]+current[2]*age2+current[3]*d1+current[4]*d2+current[5]*d3+b)
  shape=rep(current[8],38)
  bottom <- log(dgamma(prop[7],0.0001,10^4))+sum(dweibull(time1,shape,scale1))+sum(dweibulll(time2,shape,scale2))+sum(1-pweibull(time1,shape,scale1))+sum(1-pweibull(time2,shape,scale2))
  
  alpha <- exp(top-bottom)
      
  if (runif(1) < alpha){
    current <- prop
    acc.rates <- acc.rates + 1
    }
       
  #Modfifying r
  prop<-current
  #Proposition
  prop[8]<-rnorm(1,current[8],prop.sd[8])
  b<-rnorm(38,0,current[8]) #(Je sais s'il faut regéner ça :())
  #the top 
  scale1=exp(prop[1]+prop[2]*age1+prop[3]*sex+prop[4]*d1+prop[5]*d3+prop[6]*d3+b)
  scale2=exp(prop[1]+prop[2]*age2+prop[3]*sex+prop[4]*d1+prop[5]*d3+prop[6]*d3+b)
  shape=rep(prop[8],38)
  top <- log(dgamma(prop[8],1,10^(3)))+sum(dweibull(time1,shape,scale1))+sum(dweibulll(time2,shape,scale2))+sum(1-pweibull(time1,shape,scale1))+sum(1-pweibull(time2,shape,scale2))
        
  #The bottom
  scale1=exp(current[1]+current[2]*age1+current[3]*sex+current[4]*d1+current[5]*d3+current[6]*d3+b)
  scale1=exp(current[1]+current[2]*age2+current[3]*d1+current[4]*d2+current[5]*d3+b)
  shape=rep(current[8],38)
  bottom <- log(dgamma(prop[8],1,10^3))+sum(dweibull(time1,shape,scale1))+sum(dweibulll(time2,shape,scale2))+sum(1-pweibull(time1,shape,scale1))+sum(1-pweibull(time2,shape,scale2))
  
  alpha <- exp(top-bottom)
      
  if (runif(1) < alpha){
    current <- prop
    acc.rates <- acc.rates + 1
    }
      
  
  
  
  chain[i+1,] <- current
    
  return(list(chain = chain, acc.rates = acc.rates / iter))
}



```
